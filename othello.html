<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>オセロ（Firebase対応・安定版）</title>
  <style>
    :root{ --board-size: min(640px, 92vw); --bg:#0b3d2e; --control-w:320px; }
    body{ font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", Roboto, "Yu Gothic"; display:flex;gap:18px;align-items:flex-start;justify-content:center;padding:20px;background:#e9f0ed;color:#062; }
    .wrap{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;justify-content:center;}
    .board{ width:var(--board-size);height:var(--board-size); background:linear-gradient(#0f523b,#0b3d2e); display:grid; grid-template-columns:repeat(8,1fr); grid-template-rows:repeat(8,1fr); gap:2px; padding:6px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.18); }
    .cell{ background:var(--bg); border-radius:6px; position:relative; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; overflow:visible; }
    .cell:hover{ box-shadow:inset 0 0 0 2px rgba(255,255,255,0.03) }
    .disc{ width:84%; height:84%; border-radius:50%; box-shadow:inset 0 -6px 12px rgba(0,0,0,0.25); transition:transform 360ms ease; transform-style:preserve-3d; backface-visibility:hidden; }
    .disc.black{ background:linear-gradient(#222,#000) }
    .disc.white{ background:linear-gradient(#fff,#ddd) }
    .disc.flip{ transform:rotateY(180deg) }
    .legal::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      opacity: 0.9;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
      transition: transform 0.2s ease;
    }
    .cell.legal:hover::after { transform: scale(1.3); }

    .controls{ min-width:var(--control-w); display:flex; flex-direction:column; gap:10px; }
    .status{ background:#fff; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .row{ display:flex; justify-content:space-between; gap:8px; align-items:center; }
    button{ padding:8px 12px; border-radius:8px; border:none; background:#0b7a59; color:#fff; font-weight:600; cursor:pointer; }
    button.secondary{ background:#5b5b5b; }
    select,input{ padding:8px; border-radius:6px; border:1px solid #ccc; }
    .small{ font-size:0.9rem; }
    footer{ font-size:0.8rem; color:#346; text-align:center; }
    @media (max-width:720px){ body{ flex-direction:column; align-items:center } .controls{ min-width:90vw } :root{ --board-size:90vw } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="board" id="board" aria-label="オセロの盤"></div>

    <div class="controls">
      <div class="status">
        <div class="row"><div>黒 (●)</div><div id="score-black">2</div></div>
        <div class="row"><div>白 (○)</div><div id="score-white">2</div></div>
        <hr/>
        <div class="row small"><div>現在の手番</div><div id="turn">黒</div></div>
        <div class="row small"><div>合法手数</div><div id="legal-count">4</div></div>
      </div>

      <div class="status">
        <div class="row"><div>モード</div>
          <select id="modeSelect">
            <option value="cpu">シングルプレイ（CPU）</option>
            <option value="local">ローカル2人対戦</option>
            <option value="online">オンライン対戦</option>
          </select>
        </div>

        <div id="cpuPanel" style="margin-top:8px">
          <div class="row small"><div>CPU強さ</div>
            <select id="aiLevel">
              <option value="0">初級（ランダム）</option>
              <option value="1" selected>中級（最大反転）</option>
              <option value="2">上級（2手読み）</option>
            </select>
          </div>
          <div class="row small" style="margin-top:6px"><div>あなたの色</div>
            <select id="playerColor"><option value="1" selected>黒（先手）</option><option value="2">白（後手）</option></select>
          </div>
        </div>

        <div id="onlinePanel" style="display:none;margin-top:10px">
          <div class="row small"><div>オンライン</div>
            <select id="onlineMode"><option value="off">オフ</option><option value="host">部屋を作る</option><option value="join">部屋に入る</option></select>
          </div>
          <div id="onlineControls" style="display:none;margin-top:8px">
            <div style="display:flex;gap:8px">
              <input id="roomId" placeholder="部屋ID（自動生成可）"/>
              <button id="createRoom">作成</button>
              <button id="joinRoom" class="secondary">参加</button>
            </div>
            <div style="margin-top:6px">
              <div class="small">Realtime DB を使います</div>
              <small id="connectionStatus">未接続</small>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between">
        <button id="reset">リセット</button>
        <button id="undo" class="secondary">取り消し</button>
        <button id="pass" class="secondary">パス</button>
      </div>

      <div class="status small">
        <p>説明：各ターンごとに各プレイヤーは1回だけ取り消しできます（自分のターン内でのみ）。オンラインは Firebase Realtime Database を使用します。</p>
      </div>
    </div>
  </div>

  <footer>オフライン優先の統合版 — Firebase 対応（修正版）</footer>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, off, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC8x4BmjNJlqMkCbs1xIi_OkNc2Hp3UWbY",
    authDomain: "othello-online-23943.firebaseapp.com",
    databaseURL: "https://othello-online-23943-default-rtdb.firebaseio.com",
    projectId: "othello-online-23943",
    storageBucket: "othello-online-23943.appspot.com",
    messagingSenderId: "700231693409",
    appId: "1:700231693409:web:57c6b500271c80e4d2a620"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  window.__firebase = { db, ref, set, get, onValue, off, update };

  document.addEventListener("DOMContentLoaded", () => {
    const SIZE = 8;
    const DIRS = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
    let board = Array.from({length:SIZE},()=>Array(SIZE).fill(0));
    let turn = 1;
    let history = [];
    let busy = false;
    let undoUsed = {1:false,2:false};
    let fbUnsubscribe = null;
    let firebaseRoomId = null;      // ← 追加: 部屋IDを保持する変数
    let firebasePlayer = null;

    const boardEl = document.getElementById("board");
    const scoreB = document.getElementById("score-black");
    const scoreW = document.getElementById("score-white");
    const turnEl = document.getElementById("turn");
    const legalCountEl = document.getElementById("legal-count");
    const modeSelect = document.getElementById("modeSelect");
    const cpuPanel = document.getElementById("cpuPanel");
    const aiLevelSel = document.getElementById("aiLevel");
    const playerColorSel = document.getElementById("playerColor");
    const onlinePanel = document.getElementById("onlinePanel");
    const onlineModeSel = document.getElementById("onlineMode");
    const onlineControls = document.getElementById("onlineControls");
    const roomInput = document.getElementById("roomId");
    const createBtn = document.getElementById("createRoom");
    const joinBtn = document.getElementById("joinRoom");
    const connectionStatus = document.getElementById("connectionStatus");
    const resetBtn = document.getElementById("reset");
    const undoBtn = document.getElementById("undo");
    const passBtn = document.getElementById("pass");

    const FB = window.__firebase;

    function cloneBoard(b){return b.map(r=>[...r]);}
    function inside(r,c){return r>=0&&r<SIZE&&c>=0&&c<SIZE;}
    function countScores(b=board){let bC=0,wC=0;for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){if(b[r][c]===1)bC++;else if(b[r][c]===2)wC++;}return {b:bC,w:wC};}

    function saveState(){history.push({board:cloneBoard(board),turn});updateUndo();}
    function updateUndo(){
      const cur=turn;
      const m=modeSelect.value;
      if(m==="online"){undoBtn.disabled=true;}
      else undoBtn.disabled=history.length<2||busy||undoUsed[cur];
    }

    function legalMovesFor(p,b=board){
      const opp=p===1?2:1;const moves=[];
      for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){
        if(b[r][c]!==0)continue;
        for(const [dr,dc] of DIRS){
          let rr=r+dr,cc=c+dc,found=false;
          while(inside(rr,cc)&&b[rr][cc]===opp){rr+=dr;cc+=dc;found=true;}
          if(found&&inside(rr,cc)&&b[rr][cc]===p){moves.push([r,c]);break;}
        }
      }return moves;
    }

    function applyMove(p,r,c,b=board){
      const opp=p===1?2:1;
      if(b[r][c]!==0)return[];
      b[r][c]=p;const flipped=[];
      for(const [dr,dc] of DIRS){
        let rr=r+dr,cc=c+dc,path=[];
        while(inside(rr,cc)&&b[rr][cc]===opp){path.push([rr,cc]);rr+=dr;cc+=dc;}
        if(path.length&&inside(rr,cc)&&b[rr][cc]===p){for(const [fr,fc] of path){b[fr][fc]=p;flipped.push([fr,fc]);}}
      }return flipped;
    }

    function render(){
      boardEl.innerHTML="";
      const legal = legalMovesFor(turn);
      const mode = modeSelect.value;
      const isOnline = mode === "online";
      const isMyTurn = !isOnline || (firebasePlayer === turn);

      for(let r=0;r<SIZE;r++)for(let c=0;c<SIZE;c++){
        const cell=document.createElement("div");
        cell.className="cell";
        cell.dataset.r=r;
        cell.dataset.c=c;

        // 駒がある場合
        if(board[r][c]){
          const d=document.createElement("div");
          d.className="disc "+(board[r][c]===1?"black":"white");
          cell.appendChild(d);
        }
        // 駒がなく、合法手の場合にマーク
        else if(legal.some(x=>x[0]===r&&x[1]===c)){
          // オンライン時も自分の番なら表示
          if(modeSelect.value!=="online" || firebasePlayer===turn){
            cell.classList.add("legal");
          }
        }

        boardEl.appendChild(cell);
      }

      // スコアと手番表示更新
      const sc=countScores();
      scoreB.textContent=sc.b;
      scoreW.textContent=sc.w;
      turnEl.textContent=turn===1?"黒":"白";
      legalCountEl.textContent=legal.length;

      // 自分の手番なら盤の明度を上げ、相手の番なら下げる
      if(isOnline){
        boardEl.style.opacity = isMyTurn ? "1" : "0.5";
      } else {
        boardEl.style.opacity = "1";
      }

      // あなたの番メッセージを表示
      const existing = document.getElementById("turnNotice");
      if(isOnline && isMyTurn){
        if(!existing){
          const msg = document.createElement("div");
          msg.id = "turnNotice";
          msg.textContent = "あなたの番です";
          Object.assign(msg.style, {
            position: "absolute",
            top: "8px",
            left: "50%",
            transform: "translateX(-50%)",
            background: "#0b7a59",
            color: "#fff",
            padding: "6px 12px",
            borderRadius: "8px",
            fontWeight: "600",
            boxShadow: "0 2px 6px rgba(0,0,0,0.2)",
            zIndex: 100
          });
          boardEl.parentElement.appendChild(msg);
        }
      } else if(existing){
        existing.remove();
      }

      passBtn.disabled=legal.length>0||busy;
      updateUndo();

      window.turn=turn;
      window.firebasePlayer=firebasePlayer;
    }


    boardEl.addEventListener("click",e=>{
      const cell=e.target.closest(".cell");if(!cell||busy)return;
      const r=+cell.dataset.r,c=+cell.dataset.c;
      const mode=modeSelect.value;
      if(mode==="cpu"||mode==="local"){
        saveState();
        const legal=legalMovesFor(turn);
        if(!legal.some(x=>x[0]===r&&x[1]===c))return;
        applyMove(turn,r,c);
        turn=turn===1?2:1;undoUsed[turn]=false;saveState();render();
        if(mode==="cpu"&&turn!==+playerColorSel.value)setTimeout(doCpu,300);
      }else{
        if(!FB||!firebaseRoomId){alert("オンライン未接続");return;}
        if(firebasePlayer!==turn){alert("あなたの手番ではありません");return;}
        const legal=legalMovesFor(turn);
        if(!legal.some(x=>x[0]===r&&x[1]===c))return;
        sendMoveFirebase(firebaseRoomId,turn,r,c);
      }
    });

    resetBtn.onclick=()=>{if(confirm("リセットしますか？")){init();if(firebaseRoomId)setRoomFirebase(firebaseRoomId,board,turn);}};
    passBtn.onclick = async ()=>{
      if(busy)return;
      const legal = legalMovesFor(turn);
      if(legal.length>0)return; // 打てるのにパスは不可

      const mode = modeSelect.value;
      if(mode==="online" && firebaseRoomId){
        if(firebasePlayer!==turn)return; // 相手のターンでは押せない
        // 次の手番に進める（同期）
        const nextTurn = turn===1?2:1;
        await setRoomFirebase(firebaseRoomId, board, nextTurn);
      }else{
        // オフラインモード
        turn = turn===1?2:1;
        undoUsed[turn]=false;
        saveState();
        render();
      }
    };


    function ai_random(p){const m=legalMovesFor(p);return m.length?m[Math.floor(Math.random()*m.length)]:null;}
    function ai_maxflip(p){const m=legalMovesFor(p);let best=null,max=-1;for(const [r,c] of m){const b=cloneBoard(board);const f=applyMove(p,r,c,b);if(f.length>max){max=f.length;best=[r,c];}}return best;}
    function ai_minimax(p){return ai_maxflip(p);} // 簡略化

    function doCpu(){
      if(busy)return;
      const cpu=+playerColorSel.value===1?2:1;if(turn!==cpu)return;
      busy=true;setTimeout(()=>{const lvl=+aiLevelSel.value;let mv=null;if(lvl===0)mv=ai_random(cpu);else mv=ai_maxflip(cpu);if(!mv){turn=turn===1?2:1;busy=false;render();return;}applyMove(cpu,mv[0],mv[1]);turn=turn===1?2:1;undoUsed[turn]=false;saveState();busy=false;render();},400);
    }

    function initialBoard(){const b=Array.from({length:8},()=>Array(8).fill(0));b[3][3]=2;b[3][4]=1;b[4][3]=1;b[4][4]=2;return b;}
    async function setRoomFirebase(room,b,t){const r=FB.ref(FB.db,"rooms/"+room);await FB.update(r,{board:b,turn:t});}
    async function sendMoveFirebase(room,p,r,c){
      if(busy)return;
      busy=true;
      const legal = legalMovesFor(p);
      if(!legal.some(x=>x[0]===r && x[1]===c)){busy=false;return;}
      applyMove(p,r,c);
      const nextTurn = p===1?2:1;
      await setRoomFirebase(room, board, nextTurn);
      busy=false;
    }


   // --- listenRoom: onValueの戻り値（解除関数）をfbUnsubscribeに格納 ---
   function listenRoom(room) {
     // 既存のリスナー解除
     if (fbUnsubscribe) {
       try { fbUnsubscribe(); } catch(e) {}
       fbUnsubscribe = null;
     }
     const r = FB.ref(FB.db, "rooms/" + room);
     // onValue は unsubscribe 関数（解除関数）を返すのでそれを保存する
     const unsub = FB.onValue(r, snap => {
       const d = snap.val();
       if (!d || !d.board) return;
       board = d.board.map(row => row.map(x => x || 0));
       turn = d.turn || 1;
       undoUsed[turn] = false;
       // 保持している roomId を上書きしておく（安全）
       firebaseRoomId = room;
       render();
       // 表示更新
       connectionStatus.textContent = `接続: ${room}（あなたは${firebasePlayer===1?'黒':'白'}）`;
     });
     // onValue の返り値が関数ならそれを使い、なければ代替の off を使う
     if (typeof unsub === "function") {
       fbUnsubscribe = unsub;
     } else {
       fbUnsubscribe = () => { try { FB.off(r); } catch(e) {} };
     }
   }

   // --- create/join room を定義（ボタンが参照する関数） ---
   async function createRoom() {
     // ensure online controls visible
     onlineControls.style.display = "block";
     let id = roomInput.value.trim() || Math.random().toString(36).slice(2,8);
     firebaseRoomId = id;
     roomInput.value = id; // keep it in input so it doesn't vanish
     firebasePlayer = 1;
     // write initial data
     await FB.set(FB.ref(FB.db, "rooms/" + id), { board: initialBoard(), turn: 1, players: 1 });
     listenRoom(id);
     connectionStatus.textContent = "部屋作成: " + id + "（黒）";
   }

   async function joinRoom() {
     const id = roomInput.value.trim();
     if (!id) { alert("部屋IDを入力してください"); return; }
     const snap = await FB.get(FB.ref(FB.db, "rooms/" + id));
     if (!snap.exists()) { alert("部屋が存在しません"); return; }
     firebaseRoomId = id;
     roomInput.value = id;
     firebasePlayer = 2;
     // mark joined (optional)
     try { await FB.update(FB.ref(FB.db, "rooms/" + id), { players: 2 }); } catch(e){/* ignore */ }
     listenRoom(id);
     onlineControls.style.display = "block";
     connectionStatus.textContent = "部屋参加: " + id + "（白）";
   }


    createBtn.onclick=createRoom;
    joinBtn.onclick=joinRoom;
    modeSelect.onchange=()=>{cpuPanel.style.display=modeSelect.value==="cpu"?"block":"none";onlinePanel.style.display=modeSelect.value==="online"?"block":"none";render();};
    onlineModeSel.onchange=()=>{onlineControls.style.display=onlineModeSel.value==="off"?"none":"block";};
    aiLevelSel.onchange=()=>render();
    playerColorSel.onchange=()=>render();

    function init(){
      board=initialBoard();turn=1;history=[];undoUsed={1:false,2:false};saveState();render();
    }
    init();
  });
  </script>
</body>
</html>
